<h3 class="title">üóÇÔ∏è Traitement de Dossier N¬∞ : {{ dossierDetails?.dossier?.numeroDossier }}</h3>

<mat-tab-group mat-stretch-tabs="true" animationDuration="500ms" class="tab-group-container mat-elevation-z8">

  <mat-tab>
    <ng-template matTabLabel>
      <mat-icon color="primary" class="tab-icon">folder_open</mat-icon>
      <span class="tab-title">Informations du Dossier</span>
    </ng-template>

    <mat-card class="dossier-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon color="accent" class="header-icon">info</mat-icon>
          Informations G√©n√©rales
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <p><strong>Num√©ro :</strong> {{ dossierDetails?.dossier?.numeroDossier }}</p>
          <p><strong>Intitul√© :</strong> {{ dossierDetails?.dossier?.intitule }}</p>
          <p><strong>Type de Passation :</strong> {{ dossierDetails?.dossier?.typePassation }}</p>
          <p><strong>Date Soumission :</strong> {{ dossierDetails?.dossier?.dateSoumission | date:'longDate' }}</p>
          <p><strong>Charg√© :</strong> {{ dossierDetails?.chargeDossier?.name }} ({{ dossierDetails?.chargeDossier?.email }})</p>
        </div>
      </mat-card-content>
    </mat-card>

    <div *ngIf="dossierDetails?.details" class="details-section">
      <mat-card class="dossier-card details-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon color="accent" class="header-icon">description</mat-icon>
            D√©tails Sp√©cifiques
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="['GRE_A_GRE'].includes(dossierDetails?.dossier?.typePassation)" class="details-block">
            <p><strong>Montant Estim√© :</strong> {{ dossierDetails?.details?.montantEstime | number:'1.0-0' }} DA</p>
            <p><strong>Budget Estim√© :</strong> {{ dossierDetails?.details?.budgetEstime | number:'1.0-0' }} DA</p>
            <p><strong>D√©lai R√©alisation :</strong> {{ dossierDetails?.details?.delaiRealisation }} mois</p>
            <p><strong>Dur√©e Contrat :</strong> {{ dossierDetails?.details?.dureeContrat }} mois</p>
          </div>

          <div *ngIf="['APPEL_OFFRE_LANCEMENT', 'Consultation_Prestataire_de_Lancement', 'Consultation_Procurement_de_Lancement'].includes(dossierDetails?.dossier?.typePassation)" class="details-block">
            <p><strong>Montant Estim√© :</strong> {{ dossierDetails?.details?.montantEstime | number:'1.0-0' }} DA</p>
            <p><strong>Budget Estim√© :</strong> {{ dossierDetails?.details?.budgetEstime | number:'1.0-0' }} DA</p>
            <p><strong>Typologie de march√© :</strong> {{ dossierDetails?.details?.typologidemarche }}</p>
            <p><strong>D√©lai R√©alisation :</strong> {{ dossierDetails?.details?.delaiRealisation }} mois</p>
            <p><strong>Garantie :</strong> {{ dossierDetails?.details?.garantie }}</p>
          </div>

          <div *ngIf="['APPEL_OFFRE_ATTRIBUTION', 'Consultation_Prestataire_dAttribution', 'Consultation_Procurement_dAttribution'].includes(dossierDetails?.dossier?.typePassation)" class="details-block attribution-details">
            <p><strong>Fournisseur :</strong> {{ dossierDetails?.details?.nomFournisseur }}</p>
            <p><strong>Montant :</strong> {{ dossierDetails?.details?.montantContrat | number:'1.0-0' }} DA</p>
            <p><strong>Dur√©e :</strong> {{ dossierDetails?.details?.dureeContrat }} mois</p>
            <p><strong>√âtranger :</strong> <span [class.text-green-600]="dossierDetails?.details?.fournisseurEtranger" [class.text-red-600]="!dossierDetails?.details?.fournisseurEtranger">{{ dossierDetails?.details?.fournisseurEtranger ? 'Oui' : 'Non' }}</span></p>
            <p><strong>Installation Permanente :</strong> <span [class.text-green-600]="dossierDetails?.details?.fournisseurEtrangerInstallationPermanente" [class.text-red-600]="!dossierDetails?.details?.fournisseurEtrangerInstallationPermanente">{{ dossierDetails?.details?.fournisseurEtrangerInstallationPermanente ? 'Oui' : 'Non' }}</span></p>
            <p><strong>D√©lai R√©alisation :</strong> {{ dossierDetails?.details?.delaiRealisation }}</p>
            <p><strong>Exp√©rience Fournisseur :</strong> {{ dossierDetails?.details?.experiencefournisseur }}</p>
            <p><strong>Typologie de march√© :</strong> {{ dossierDetails?.details?.typologidemarche }}</p>
            <p><strong>Garantie :</strong> {{ dossierDetails?.details?.garantie }}</p>
            <p><strong>Nombre de projets similaires :</strong> {{ dossierDetails?.details?.nombredeprojetssimilaires }}</p>
            <p><strong>Notation interne :</strong> {{ dossierDetails?.details?.notationinterne }}</p>
            <p><strong>Chiffre d'affaires :</strong> {{ dossierDetails?.details?.chiffreaffaire }}</p>
            <p><strong>Situation fiscale :</strong> {{ dossierDetails?.details?.situationfiscale }}</p>
            <p><strong>Fournisseur blacklist :</strong> <span [class.text-green-600]="dossierDetails?.details?.fournisseurblacklist === 'Non'" [class.text-red-600]="dossierDetails?.details?.fournisseurblacklist === 'Oui'">{{ dossierDetails?.details?.fournisseurblacklist }}</span></p>
            <p><strong>Type fournisseur :</strong> {{ dossierDetails?.details?.typefournisseur }}</p>
            <p><strong>Origine Pays Non Double Imposition :</strong> <span [class.text-green-600]="dossierDetails?.details?.originePaysNonDoubleImposition" [class.text-red-600]="!dossierDetails?.details?.originePaysNonDoubleImposition">{{ dossierDetails?.details?.originePaysNonDoubleImposition ? 'Oui' : 'Non' }}</span></p>
          </div>

          <div *ngIf="dossierDetails?.dossier?.typePassation === 'AVENANT'" class="details-block avenant-details">
            <p><strong>Num√©ro Contrat :</strong> {{ dossierDetails?.details?.numeroContrat }}</p>
            <p><strong>Date Signature :</strong> {{ dossierDetails?.details?.dateSignatureContrat | date:'longDate' }}</p>
            <p><strong>Dur√©e :</strong> {{ dossierDetails?.details?.dureeContrat }} mois</p>
            <p><strong>Expiration :</strong> {{ dossierDetails?.details?.dateExpirationContrat | date:'longDate' }}</p>
            <p><strong>Montant :</strong> {{ dossierDetails?.details?.montantContrat | number:'1.0-0' }} DA</p>
            <p><strong>Objet :</strong> {{ dossierDetails?.details?.objetAvenant }}</p>
            <p><strong>Montant Avenant :</strong> {{ dossierDetails?.details?.montantAvenant | number:'1.0-0' }} DA</p>
            <p><strong>Dur√©e Avenant :</strong> {{ dossierDetails?.details?.dureeAvenant }} mois</p>
            <p><strong>Nouveau Montant :</strong> {{ dossierDetails?.details?.nouveauMontantContrat | number:'1.0-0' }} DA</p>
            <p><strong>Nouvelle Dur√©e :</strong> {{ dossierDetails?.details?.nouvelleDureeContrat }} mois</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </mat-tab>

  <mat-tab>
    <ng-template matTabLabel>
      <mat-icon color="accent" class="tab-icon">attach_file</mat-icon>
      <span class="tab-title">Documents Associ√©s</span>
    </ng-template>

    <mat-card class="dossier-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon color="primary" class="header-icon">folder_zip</mat-icon>
          Documents li√©s
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <app-dossier-files [dossierDetails]="dossierDetails"></app-dossier-files>
      </mat-card-content>
    </mat-card>
  </mat-tab>

  <mat-tab>
    <ng-template matTabLabel>
      <mat-icon color="primary" class="tab-icon">check_circle</mat-icon>
      <span class="tab-title">D√©cision Personnelle et Verification</span>
    </ng-template>

    <h3 class="section-title">D√©cision Personnelle par les autres collaborateurs</h3>
    <div class="collaborator-results-container" *ngIf="resultats && resultats.length > 0; else noCollaboratorResults">
      <div *ngFor="let r of resultats" class="result-card collaborator-result-card">
        <p class="collaborator-info">D√©cision Personnelle par : <strong>{{ r.chargeDossierName }}</strong> ({{ r.chargeDossierEmail }}) </p>
        <div
          class="result-header"
          [ngClass]="{
    'result-accepted': r.resultat?.toLowerCase() === 'accept√©',
    'result-rejected': r.resultat?.toLowerCase() === 'refus√©'
  }"
        >
          <mat-icon class="result-icon" *ngIf="r.resultat?.toLowerCase() === 'accept√©'">check_circle</mat-icon>
          <mat-icon class="result-icon" *ngIf="r.resultat?.toLowerCase() === 'refus√©'">cancel</mat-icon>

          <span class="font-semibold text-base capitalize">
    {{ r.resultat }}
  </span>
        </div>

        <div class="result-body">
          <p><strong>Compte-rendu :</strong> {{ r.compteRendu || 'Non renseign√©' }}</p>
          <p><strong>Date d'ajout :</strong> {{ r.dateAjout | date: 'medium' }}</p>
        </div>
      </div>
    </div>
    <ng-template #noCollaboratorResults>
      <p class="no-results-message">Aucun D√©cision Personnelle de collaborateur pour le moment.</p>
    </ng-template>
    <mat-card *ngIf="['APPEL_OFFRE_ATTRIBUTION', 'Consultation_Prestataire_dAttribution', 'Consultation_Procurement_dAttribution'].includes(dossierDetails?.dossier?.typePassation)" class="dossier-card ai-verification-card">
      <mat-card-title class="card-title-with-icon">
        <mat-icon class="header-icon">smart_toy</mat-icon>
        V√©rification par IA <br> <br> <button mat-raised-button color="primary" (click)="verifyWithIA()" [disabled]="loadingIA" class="ia-verify-button">
        <mat-icon class="mr-1">auto_awesome</mat-icon>
        {{ loadingIA ? 'Analyse en cours...' : 'V√©rifier par IA' }}
      </button>
      </mat-card-title>
      <mat-card-content>


        <div *ngIf="loadingIA" class="loading-spinner">
          <mat-progress-bar mode="indeterminate" color="accent"></mat-progress-bar>
        </div>
        <div class="results-container" *ngIf="!loadingIA">
          <ng-container *ngIf="predictionResultRF || predictionResultxgboost || predictionResultknn || predictionResultSVM || predictionResultAdaBoost || predictionResultNaiveBayes; else noAIResults">
            <div *ngIf="predictionResultRF" class="result-card ia-result-card">
              <h4>Random Forest</h4>
              <ng-container *ngTemplateOutlet="resultTemplate; context: { result: predictionResultRF }"></ng-container>
            </div>

            <div *ngIf="predictionResultxgboost" class="result-card ia-result-card">
              <h4>XGBoost</h4>
              <ng-container *ngTemplateOutlet="resultTemplate; context: { result: predictionResultxgboost }"></ng-container>
            </div>
          </ng-container>

          <ng-template #noAIResults>
            <p class="no-results-message">Aucun r√©sultat de pr√©diction par IA pour le moment.</p>
          </ng-template>
        </div>

        <ng-template #resultTemplate let-result="result">
          <p class="prediction-outcome">
            <span class="prediction-label"
                  [ngClass]="{
                    'prediction-accorde': result.prediction === 'Visa Accord√©',
                    'prediction-refuse': result.prediction === 'Visa Refus√©'
                  }">
              {{ result.prediction }}
            </span>
          </p>
          <p><strong>Confiance :</strong></p>
          <ul class="confidence-list">
            <li>Visa Accord√© : {{ result.confidence['Visa Accord√©'] }} %</li>
            <li>Visa Refus√© : {{ result.confidence['Visa Refus√©'] }} %</li>
          </ul>
        </ng-template>
      </mat-card-content>
    </mat-card>

  </mat-tab>


  <mat-tab>
    <ng-template matTabLabel>
      <mat-icon color="primary" class="tab-icon">how_to_vote</mat-icon>
      <span class="tab-title">D√©cision Personnelle</span>
    </ng-template>

    <mat-card class="dossier-card final-decision-card">
      <mat-card-title class="card-title-with-icon">
        <mat-icon class="header-icon">gavel</mat-icon>
        Prendre une D√©cision Personnelle
      </mat-card-title>
      <mat-card-content>
        <div *ngIf="isLoading" class="text-center my-4">
          <div class="spinner-border" role="status" aria-hidden="true"></div>
          <span class="visually-hidden">Chargement...</span>
        </div>

        <div *ngIf="!isLoading">
          <section *ngIf="resultatExistant; else formTemplate" class="mb-4 p-3 border rounded bg-light existing-result-section">
            <h3 class="mb-3">D√©cision Personnelle existante :</h3>
            <p><strong>D√©cision Personnelle :</strong></p>
            <p class="border rounded p-2 bg-white existing-result-content">{{ resultatExistant.resultat }}</p>

            <p><strong>Compte rendu :</strong></p>
            <p class="border rounded p-2 bg-white existing-result-content">{{ resultatExistant.compteRendu }}</p>
          </section>

          <ng-template #formTemplate>
            <form [formGroup]="resultatForm" (ngSubmit)="onSubmit()" novalidate class="tab-form-content needs-validation" [class.was-validated]="resultatForm.invalid && resultatForm.touched">
              <fieldset class="form-fieldset">
                <legend>Ajouter une D√©cision Personnelle et un compte rendu</legend>

                <mat-form-field appearance="outline" class="full-width-input">
                  <mat-label>D√©cision Personnelle</mat-label>
                  <mat-select formControlName="resultat" required>
                    <mat-option value="Accept√©">Accept√©</mat-option>
                    <mat-option value="Refus√©">Refus√©</mat-option>
                  </mat-select>
                  <mat-error *ngIf="resultatForm.get('resultat')?.invalid && resultatForm.get('resultat')?.touched">
                    La D√©cision Personnelle est requise.
                  </mat-error>
                </mat-form-field>
                <mat-form-field appearance="outline" class="full-width-input">
                  <mat-label>Compte rendu</mat-label>
                  <textarea
                    matInput
                    formControlName="compteRendu"
                    rows="5"
                    placeholder="Fournissez un compte rendu d√©taill√©."
                    required
                  ></textarea>
                  <mat-error *ngIf="resultatForm.get('compteRendu')?.invalid && resultatForm.get('compteRendu')?.touched">
                    Le compte rendu est requis.
                  </mat-error>
                </mat-form-field>
              </fieldset>

              <div class="button-row form-actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="resultatForm.invalid">
                   Soumettre la D√©cision
                </button>
                <button mat-stroked-button color="warn" type="button" (click)="resultatForm.reset()">
                  Annuler
                </button>
              </div>
            </form>
          </ng-template>
        </div>
      </mat-card-content>
    </mat-card>
  </mat-tab>

</mat-tab-group>
